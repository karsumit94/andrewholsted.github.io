<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>FajitaNachos</title>
        <meta name="description" content="">
        <meta name="viewport" content="initial-scale=1.0">
        <meta name="google-site-verification" content="4HbcEJrScd-HLuYgKXqzPgDKlZkWgfHyCRvb3IGIwYk" />
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Lora' rel='stylesheet' type='text/css'> 
        <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
        <link rel="icon" type="image/png" href="/images/favicon.png">

        <link href="/css/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/css/main.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/css/pygments.css" media="screen" rel="stylesheet" type="text/css" />
        <script src="/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
  
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

    <body class="Fullcalendar-and-recurring-events Fullcalendar-and-recurring-events_index">
               <div id="post-wrap">
    <div id = "post-header">
      <ul>
       <li class = "social"><a href="https://github.com/AndrewHolsted/"> <img src="/images/github.png" /> </a>
        </li>
        <li> <h1><a href ="/">FajitaNachos</a></h1></li>
       <li class = "social"><a href="https://twitter.com/FajitaNachos/"> <img src="/images/twitter.png" /> </a>
        </li>
      </ul>
    </div>
    <div id = "post-container">
      <article>
      	<h1 id = "post-title">Fullcalendar and Recurring Events</h1>
        <div id = "post-content">
           <p>I&#39;m currently using arshaw&#39;s <a href="http://arshaw.com/fullcalendar/">fullcalendar</a> for a project I&#39;m working on. It&#39;s a nice calendar with great documentation. However, it is up to the developers to implement their own back end for the calendar. Here&#39;s one way to do it using PHP and MySQL.</p>

<p>First, I use two MySQL tables to store the event data. One is called &#39;events_parent&#39; and the other is &#39;events&#39;. Each event can have only one parent event.</p>

<p>The events_parent table </p>

<table id="fc-parent-events">
    <tbody>
        <tr class="fc-table-header">
            <td>Field</td>
            <td>Type</td>
            <td>Key</td>
            <td>Default</td>
            <td>Extra</td>
        </tr>
        <tr class="first-row">
            <td>parent_id</td>
            <td>int(30)unsigned</td>
            <td>primary</td>
            <td>NULL</td>
            <td>auto_increment</td>
        </tr>
        <tr>
            <td>title</td>
            <td>varchar(120)</td>
            <td></td>
            <td>NULL</td>
            <td></td>
        </tr>
        <tr>
            <td>weekday</td>
            <td>int(1)</td>
            <td></td>
            <td>NULL</td>
            <td></td>
        </tr>
        <tr>
            <td>start_date</td>
            <td>date</td>
            <td></td>
            <td>NULL</td>
            <td></td>
        </tr>
        <tr>
            <td>start_time</td>
            <td>time</td>
            <td></td>
            <td>NULL</td>
            <td></td>
        </tr>
        <tr>
            <td>end_time</td>
            <td>time</td>
            <td></td>
            <td>NULL</td>
            <td></td>
        </tr>
        <tr>
            <td>repeats</td>
            <td>tinyint(1)</td>
            <td></td>
            <td>NULL</td>
            <td></td>
        </tr>
        <tr>
            <td>repeat_freq</td>
            <td>tinyint(1)</td>
            <td></td>
            <td>NULL</td>
            <td></td>
        </tr>
    </tbody>
</table>

<p>The events table</p>

<div class="code-wrap">
    <table id="fc-events">
        <tbody>
            <tr class="fc-table-header">
                <td>Field</td>
                <td>Type</td>
                <td>Key</td>
                <td>Default</td>
                <td>Extra</td>
            </tr>
            <tr class="first-row">
                <td>event_id</td>
                <td>int(30)unsigned</td>
                <td>primary</td>
                <td>NULL</td>
                <td>auto_increment</td>
            </tr>
            <tr>
                <td>parent_id</td>
                <td>int(30)unsigned</td>
                <td></td>
                <td>NULL</td>
                <td></td>
            </tr>
            <tr>
                <td>start</td>
                <td>datetime</td>
                <td></td>
                <td>NULL</td>
                <td></td>
            </tr>
            <tr>
                <td>end</td>
                <td>datetime</td>
                <td></td>
                <td>NULL</td>
                <td></td>
            </tr>
            <tr>
                <td>title</td>
                <td>varchar(120)</td>
                <td></td>
                <td>NULL</td>
                <td></td>
            </tr>
        </tbody>
    </table>
</div>

<p><strong>weekday</strong> - 1 for Monday, 2 for Tuesday etc. I use 0 if the event repeats daily since the starting weekday name doesn&#39;t really matter in that case. </p>

<p><strong>repeats</strong> - 1 for recurring events and 0 for single events. </p>

<p><strong>repeat_freq</strong> - 0 for non-repeating events, 1 for daily, 7 for weekly, 14 for every other week etc. </p>

<p>I think everything else is pretty self explanatory. </p>

<p>Including fullcalendar is just like loading any other external js file.
<code>html
    &lt;script type=&quot;text/javascript&quot; src=&quot;/path_to_your_fullcalendar_folder/fullcalendar.js&quot;&gt; &lt;/script&gt;
</code></p>

<p>You have several options as to where you pull your event data from. I chose to pass a URL to a php file where I fetch the events and return them (via JSON).</p>
<pre class="highlight javascript"><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
    <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">calendar</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#calendar&#39;</span><span class="p">).</span><span class="nx">fullCalendar</span><span class="p">({</span>
    <span class="c1">//configure options for the calendar
</span>       <span class="nl">header</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">left</span><span class="p">:</span> <span class="s1">&#39;prev,next today&#39;</span><span class="p">,</span>
          <span class="na">center</span><span class="p">:</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
          <span class="na">right</span><span class="p">:</span> <span class="s1">&#39;month,agendaWeek,agendaDay&#39;</span>
       <span class="p">},</span>


       <span class="c1">// this is where you specify where to pull the events from.
</span>
       <span class="nl">events</span><span class="p">:</span> <span class="s2">&quot;includes/json-events.php&quot;</span><span class="p">,</span>
       <span class="nl">editable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
       <span class="nl">defaultView</span><span class="p">:</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span>
       <span class="nl">allDayDefault</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
       <span class="c1">//etc etc
</span>   <span class="p">});</span>
<span class="p">});</span>
</pre>
<p>This is the json-events.php page</p>
<pre class="highlight php"><span class="cp">&lt;?php</span> 
    <span class="k">require_once</span> <span class="s1">&#39;../../../config/db-config.php&#39;</span><span class="p">;</span>

    <span class="nv">$dbh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s2">&quot;mysql:host=</span><span class="nv">$mysql_hostname</span><span class="s2">;dbname=</span><span class="nv">$mysql_dbname</span><span class="s2">, </span><span class="nv">$mysql_username</span><span class="s2">, </span><span class="nv">$mysql_password</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;SELECT event_id, parent_id, title, start, end
                           FROM events&quot;</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="p">;</span><span class="nx">execute</span><span class="p">();</span>
    <span class="nv">$events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="p">;</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">FETCH_ASSOC</span><span class="p">)){</span>
        <span class="nv">$eventArray</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;event_id&#39;</span><span class="p">];</span>
        <span class="nv">$eventArray</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">];</span>
        <span class="nv">$eventArray</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">stripslashes</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]);</span>
        <span class="nv">$eventArray</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">];</span>
        <span class="nv">$eventArray</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">];</span>
        <span class="nv">$events</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$eventArray</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$events</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</pre>
<p>I query the database for all the events in my events table, put them in an array, JSON encode the array, and echo it out. Fullcalendar implements &quot;lazy fetching&quot; where it will only pull the events that are needed for the current, previous, and next month views. The other events are loaded as needed through URL parameters. Obviously if it gets to the point where there are 10 or 20 thousand events then I&#39;ll probably need to optimize the query.</p>

<p>Alright, let&#39;s make some bacon. And by that I mean let&#39;s add an event to the calendar. I have a div with the display set to none. I open this div as a dialog with the event select callback. Here&#39;s the div.</p>
<pre class="highlight html"><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;add-event&quot;</span> <span class="na">title=</span><span class="s">&quot;Add New Event&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">id =</span><span class="s">&quot;add-event-form&quot;</span> <span class="na">name=</span><span class="s">&quot;add-event-form&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Event Name<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span> <span class="na">id=</span><span class="s">&quot;title&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;p&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;add-date&quot;</span><span class="nt">&gt;</span>Date<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;event-date&quot;</span> <span class="na">id=</span><span class="s">&quot;event-date&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;-1&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;add-start-time&quot;</span><span class="nt">&gt;</span>Start Time<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;start-time&quot;</span> <span class="na">id=</span><span class="s">&quot;start-time&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;add-end-time&quot;</span><span class="nt">&gt;</span>End Time<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;end-time&quot;</span> <span class="na">id=</span><span class="s">&quot;end-time&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;repeats&quot;</span><span class="nt">&gt;</span>repeat <span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name=</span><span class="s">&quot;repeats&quot;</span> <span class="na">id=</span><span class="s">&quot;repeats&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;repeat-options&quot;</span> <span class="nt">&gt;</span>
             Repeat every: day <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="na">name=</span><span class="s">&quot;repeat-freq&quot;</span> <span class="na">align=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
             week <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;7&quot;</span> <span class="na">name=</span><span class="s">&quot;repeat-freq&quot;</span> <span class="na">align=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
             two weeks <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">value=</span><span class="s">&quot;14&quot;</span> <span class="na">name=</span><span class="s">&quot;repeat-freq&quot;</span> <span class="na">align=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre>
<p>Next, the js for the dialog</p>
<pre class="highlight javascript"><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;add-event&quot;</span><span class="p">).</span><span class="nx">dialog</span><span class="p">({</span>
    <span class="na">autoOpen</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">height</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="na">width</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="na">autoResize</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
    <span class="na">modal</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">resizable</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">open</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#title&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;tabindex&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">buttons</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Save Event&quot;</span><span class="err">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="na">type</span><span class="p">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
                <span class="na">url</span><span class="p">:</span> <span class="s2">&quot;includes/add-event.php&quot;</span><span class="p">,</span>
                <span class="na">data</span><span class="p">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#add-event-form&#39;</span><span class="p">).</span><span class="nx">serialize</span><span class="p">(),</span>
                <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
                    <span class="nx">calendar</span><span class="p">.</span><span class="nx">fullCalendar</span><span class="p">(</span><span class="s1">&#39;refetchEvents&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">dialog</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="na">Cancel</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">dialog</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre>
<p>Finally, let&#39;s have a look at the add-event.php page</p>
<pre class="highlight php"><span class="cp">&lt;?php</span>
    <span class="k">require_once</span> <span class="s1">&#39;../../../config/db-config.php&#39;</span><span class="p">;</span>
    <span class="nv">$title</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">];</span> <span class="nv">$start_date</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;event-date&#39;</span><span class="p">];</span>
    <span class="nv">$weekday</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$start_date</span><span class="p">));</span>
    <span class="nv">$start_time</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;start-time&#39;</span><span class="p">];</span>
    <span class="nv">$end_time</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;end-time&#39;</span><span class="p">];</span>
    <span class="nv">$start</span> <span class="o">=</span> <span class="nv">$start_date</span> <span class="o">.</span> <span class="s2">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$start_time</span><span class="p">;</span> <span class="nv">$end</span> <span class="o">=</span> <span class="nv">$start_date</span> <span class="o">.</span> <span class="s2">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$end_time</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;repeats&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$repeats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$repeat_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$dbh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s2">&quot;mysql:host=</span><span class="nv">$mysql_hostname</span><span class="s2">;dbname=</span><span class="nv">$mysql_dbname</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$mysql_username</span><span class="p">,</span> <span class="nv">$mysql_password</span><span class="p">);</span>
        <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>  
        <span class="k">try</span><span class="p">{</span>
            <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO events_parent 
                (title,start_date, start_time, end_time, weekday, repeats, repeat_freq)
                VALUES (:title,:start_date, :start_time, :end_time, :weekday, :repeats, :repeat_freq)&quot;</span><span class="p">);</span>

            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:title&#39;</span><span class="p">,</span> <span class="nv">$title</span> <span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:start_date&#39;</span><span class="p">,</span> <span class="nv">$start_date</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:start_time&#39;</span><span class="p">,</span> <span class="nv">$start_time</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:end_time&#39;</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:weekday&#39;</span><span class="p">,</span> <span class="nv">$weekday</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:repeats&#39;</span><span class="p">,</span> <span class="nv">$repeats</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:repeat_freq&#39;</span><span class="p">,</span> <span class="nv">$repeat_freq</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
            <span class="nv">$last_id</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">lastInsertId</span><span class="p">();</span>

            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO events 
                (parent_id, title, start, end)
                VALUES (:parent_id, :title, :start, :end)&quot;</span><span class="p">);</span>

            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:title&#39;</span><span class="p">,</span> <span class="nv">$title</span> <span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:start&#39;</span><span class="p">,</span> <span class="nv">$start</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:end&#39;</span><span class="p">,</span> <span class="nv">$end</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:parent_id&#39;</span><span class="p">,</span> <span class="nv">$last_id</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>

            <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">){</span>
            <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$repeats</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;repeats&#39;</span><span class="p">];</span>
        <span class="nv">$repeat_freq</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;repeat-freq&#39;</span><span class="p">];</span>
        <span class="nv">$until</span> <span class="o">=</span> <span class="p">(</span><span class="mi">365</span><span class="o">/</span><span class="nv">$repeat_freq</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$repeat_freq</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
            <span class="nv">$weekday</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$dbh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s2">&quot;mysql:host=</span><span class="nv">$mysql_hostname</span><span class="s2">;dbname=</span><span class="nv">$mysql_dbname</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$mysql_username</span><span class="p">,</span> <span class="nv">$mysql_password</span><span class="p">);</span>
        <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_ERRMODE</span><span class="p">,</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">ERRMODE_EXCEPTION</span><span class="p">);</span>  <span class="c1">// set the error mode to excptions
</span>        <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO events_parent 
                (title,start_date, start_time, end_time, weekday, repeats, repeat_freq)
                VALUES (:title, :start_date, :start_time, :end_time, :weekday, :repeats, :repeat_freq)&quot;</span><span class="p">);</span>

            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:title&#39;</span><span class="p">,</span> <span class="nv">$title</span> <span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:start_date&#39;</span><span class="p">,</span> <span class="nv">$start_date</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:start_time&#39;</span><span class="p">,</span> <span class="nv">$start_time</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:end_time&#39;</span><span class="p">,</span> <span class="nv">$end_time</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:weekday&#39;</span><span class="p">,</span> <span class="nv">$weekday</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:repeats&#39;</span><span class="p">,</span> <span class="nv">$repeats</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:repeat_freq&#39;</span><span class="p">,</span> <span class="nv">$repeat_freq</span><span class="p">);</span>
            <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
            <span class="nv">$last_id</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">lastInsertId</span><span class="p">();</span>

            <span class="k">for</span><span class="p">(</span><span class="nv">$x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$x</span> <span class="o">&lt;</span><span class="nv">$until</span><span class="p">;</span> <span class="nv">$x</span><span class="o">++</span><span class="p">){</span>
                <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO events 
                    (title, start, end, parent_id)
                    VALUES (:title, :start, :end, :parent_id)&quot;</span><span class="p">);</span>
                <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:title&#39;</span><span class="p">,</span> <span class="nv">$title</span> <span class="p">);</span>
                <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:start&#39;</span><span class="p">,</span> <span class="nv">$start</span><span class="p">);</span>
                <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:end&#39;</span><span class="p">,</span> <span class="nv">$end</span><span class="p">);</span>
                <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:parent_id&#39;</span><span class="p">,</span> <span class="nv">$last_id</span><span class="p">);</span>
                <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
                <span class="nv">$start_date</span> <span class="o">=</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$start</span> <span class="o">.</span> <span class="s1">&#39;+&#39;</span> <span class="o">.</span> <span class="nv">$repeat_freq</span> <span class="o">.</span> <span class="s1">&#39;DAYS&#39;</span><span class="p">);</span>
                <span class="nv">$end_date</span> <span class="o">=</span> <span class="nb">strtotime</span><span class="p">(</span><span class="nv">$end</span> <span class="o">.</span> <span class="s1">&#39;+&#39;</span> <span class="o">.</span> <span class="nv">$repeat_freq</span> <span class="o">.</span> <span class="s1">&#39;DAYS&#39;</span><span class="p">);</span>
                <span class="nv">$start</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s2">&quot;Y-m-d H:i&quot;</span><span class="p">,</span> <span class="nv">$start_date</span><span class="p">);</span>
                <span class="nv">$end</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s2">&quot;Y-m-d H:i&quot;</span><span class="p">;,</span> <span class="nv">$end_date</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">){</span>
            <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">header</span> <span class="p">(</span><span class="s2">&quot;location: ../&quot;</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</pre>
<p>Every time I add an event to the calendar, I insert a row into the parent<em>events table. After I insert the row, I grab the new parent</em>id using lastInsertId(). Next, I run a loop and insert a row for every occurrence of the event until the end date.This allows me to do a few things. One, I can change any single event and it won&#39;t affect any of the other events. Two, I can edit all events by using their common parent id. Three, I can still delete all occurrences of an event by deleting the relevant rows from the events table using the parent_id</p>

<p>There are a couple of caveats to this method. The author of fullcalendar recommends to have each repeating event share the same event<em>id. I did it this way initially, but decided that I didn&#39;t really like it. When you have a set of repeating events share a common event</em>id then you have to ask the user every time they want to change an event, if they want to change only <em>this</em> event or <em>all</em> the events. Another problem I ran into was when a user wanted to drag and drop an event to a new day/time. The user would drop the event on a new location and <em>all</em> of the events would be moved forward or backward by that amount of time (called dayDelta and minuteDelta in fullcalendar). To only move a single event I needed to assign a new event_id to that one event (not a big deal) and refetch all the events which would make them revert back to their original spots (the revert part was the big deal). It just wasn&#39;t a very smooth experience.</p>

<p>So, I made the choice to allow my users to only edit individual events directly from the calendar and to go to a different page if they wanted to change all occurrences of an event. I&#39;ll be the first to admit that this isn&#39;t ideal, but it is a smoother user experience than having multiple dialog windows asking if they want to change one event or all events, delete one event or all events, etc. It&#39;s not the best or most efficient way to implement recurring events. For example, my users are currently limited to only having repeating events daily, weekly, bi-weekly, and monthly. For now, it works and it works well for my needs. </p>

<p>So that is the basic flow of how I add recurring events to the calendar. I won&#39;t get into editing events or deleting events in detail. Deleting an event is as simple as making an AJAX request with the parent<em>id and deleting the relevant row from the parent</em>events table. To edit an event (in my case) you are only editing one instance of an event. Simply make an AJAX request using the current event_id and update the row in your events table to the new start time and end time.</p>

<p>That&#39;s about it. If you have questions feel free to get in touch and I&#39;ll do my best to help you out.</p>

        </div>
           <div id ="post-nav"> 
        
          <div id="previous-post">
            <a href="/The-Backstory/">The Backstory</a> 
          </div> 
         

        
          <div id="next-post"> 
            <a href="/Quick-Preview/">Quick Preview</a> 
        
          </div> 
        
      </div>
      </article>
    </div>
  </div>


             
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>

        <script src="/js/all.js" type="text/javascript"></script>

        <script>
            var _gaq=[['_setAccount','UA-34699920-1'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
           

    </body>
</html>
